!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","zxcvbn","stratus.components.singleSignOn","stratus.services.model","stratus.services.utility","stratus.directives.passwordCheck","stratus.directives.compileTemplate"],factory):factory(root.Stratus,root._,root.angular,root.zxcvbn)}(this,function(Stratus,_,angular,zxcvbn){Stratus.Components.UserAuthentication={bindings:{isLoggedIn:"<",email:"<"},controller:function($scope,$window,$attrs,$compile,Model,utility){utility.componentInitializer(this,$scope,$attrs,"user_authentication",!0);var $ctrl=this;function verifyAccount(){resetDefaultSettings(),$ctrl.loading=!0,$ctrl.user.meta.temp("api.options.action","Verify"),$ctrl.user.set("token",utility.getUrlParams().token),$ctrl.user.save().then(function(){$ctrl.loading=!1,$ctrl.message=_.first($ctrl.user.meta.get("status")).message,$ctrl.enabledVerificationForm=!1,$ctrl.isRequestSuccess=!$ctrl.user.error,$ctrl.user.error||($ctrl.enabledResetPassForm=!0,$ctrl.resetPassHeaderText="Please create a new secure password for your account.",$ctrl.changePassBtnText="Update password")})}function doSignIn(signInData){$ctrl.loading=!0,resetDefaultSettings(),$ctrl.login.set("email",signInData.email),$ctrl.login.set("password",signInData.password),$ctrl.login.save().then(function(response){if($ctrl.loading=!1,!$ctrl.login.error)return $window.location.href="/";$ctrl.isRequestSuccess=!1,$ctrl.message=_.first($ctrl.login.meta.get("status")).message})}function doSignUp(signupData){if($ctrl.loading=!0,$ctrl.socialMode)return email=signupData.email,$ctrl.loading=!1,void $scope.$broadcast("doSocialSignup",email);var email;resetDefaultSettings();var data={email:signupData.email,phone:utility.cleanedPhoneNumber(signupData.phone)};$ctrl.user.meta.temp("api.options.apiSpecialAction","SignUp"),$ctrl.user.save(data).then(function(response){if($ctrl.loading=!1,utility.getStatus(response).code===utility.RESPONSE_CODE.success)return $window.location.href="/";$ctrl.isRequestSuccess=!1;var status=utility.getStatus(response);$ctrl.message="DUPLICATE"===status.code?$ctrl.duplicateMessge:status.message})}function doRequestResetPass(resetPassData){$ctrl.loading=!0,resetDefaultSettings();var data={type:"reset-password-request",email:resetPassData.email,phone:utility.cleanedPhoneNumber(resetPassData.phone)};$ctrl.user.meta.temp("api.options.apiSpecialAction","ResetPasswordRequest"),$ctrl.user.save(data).then(function(response){$ctrl.loading=!1,utility.getStatus(response).code===utility.RESPONSE_CODE.success?$ctrl.isRequestSuccess=!0:$ctrl.isRequestSuccess=!1,$ctrl.message=utility.getStatus(response).message})}function doResetPass(resetPassData){$ctrl.loading=!0,resetDefaultSettings();var data={type:"verify"===utility.getUrlParams().type?"change-password":utility.getUrlParams().type,email:utility.getUrlParams().email,token:utility.getUrlParams().token,password:resetPassData.password};$ctrl.passwordReset&&(data.email=$ctrl.email,data.type="update-password",data.confirm_password=resetPassData.confirm_password),$ctrl.user.meta.temp("api.options.apiSpecialAction","ResetPassword"),$ctrl.user.save(data).then(function(response){$ctrl.loading=!1,utility.getStatus(response).code===utility.RESPONSE_CODE.success?$window.location.href=$window.location.origin+"/Member/Sign-In":($ctrl.isRequestSuccess=!1,$ctrl.message=utility.getStatus(response).message)})}function showForgotPassForm(isShow){$ctrl.message=null,$ctrl.forgotPassText=isShow?"Back to login":"Forgot Password?",$ctrl.enabledForgotPassForm=isShow,isShow||onTabSelected($ctrl.signInIndex)}function backToLogin(){$ctrl.message=null,$ctrl.isHandlingUrl=!1}function onTabSelected(index){$ctrl.selectedIndex=index,$ctrl.message=null}function resetDefaultSettings(){$ctrl.socialMode=!1,$ctrl.message=null}function safeMessage(){return utility.safeMessage($ctrl.message)}$ctrl.$onInit=function(){$ctrl.signinData={},$ctrl.resetPassData={},$ctrl.allowSubmit=!1,$ctrl.socialMode=!1,$ctrl.loading=!1,$ctrl.signInIndex=0,$ctrl.signUpIndex=1,$ctrl.emailRegex=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/i,$ctrl.phoneRegex=/^[\d+\-().]+$/,$ctrl.enabledForgotPassForm=!1,$ctrl.isHandlingUrl=null!==utility.getUrlParams().type,$ctrl.passwordReset=!!$ctrl.isLoggedIn&&!$ctrl.isHandlingUrl,$ctrl.enabledResetPassForm="reset-password"===utility.getUrlParams().type,$ctrl.enabledVerificationForm="verify"===utility.getUrlParams().type,$ctrl.forgotPassText="Forgot Password?",$ctrl.resetPassHeaderText="Reset your account password",$ctrl.changePassBtnText="Reset Password",$ctrl.selectedIndex=$ctrl.signInIndex,$ctrl.message=null,$ctrl.isRequestSuccess=!1,$ctrl.passwordReset?$ctrl.resetPassHeaderEmail=$ctrl.email:"reset-password"===utility.getUrlParams().type?$ctrl.resetPassHeaderEmail=utility.getUrlParams().email:$ctrl.resetPassHeaderEmail=null,$ctrl.duplicateMessge='<span>There is already an account registered to this email, please <a href="#" ng-click="$ctrl.onTabSelected($ctrl.signInIndex)">Sign In</a> and then create a new site from the control panel.</span>',$ctrl.showForgotPassForm=showForgotPassForm,$ctrl.doSignIn=doSignIn,$ctrl.doSignUp=doSignUp,$ctrl.doRequestResetPass=doRequestResetPass,$ctrl.doResetPass=doResetPass,$ctrl.onTabSelected=onTabSelected,$ctrl.backToLogin=backToLogin,$ctrl.verifyAccount=verifyAccount,$ctrl.safeMessage=safeMessage,$ctrl.login=new Model({target:"login"}),$ctrl.user=new Model({target:"user"})},$scope.$watch(angular.bind(this,function(){return _.isEmpty(this.signinData)?_.isEmpty(this.resetPassData)?void 0:($ctrl.isRequestSuccess=!1,this.resetPassData.password):this.signinData.password}),function(newValue,oldValue){if(void 0!==newValue&&newValue!==oldValue){var strengthBar=utility.generateStrengthBar(newValue,zxcvbn);$ctrl.progressBarClass=strengthBar.progressBarClass,$ctrl.progressBarValue=strengthBar.progressBarValue,utility.validPassword(newValue)?($ctrl.message=null,$ctrl.allowSubmit=!0,void 0!==$ctrl.resetPassData.confirm_password&&$ctrl.resetPassData.confirm_password!==newValue&&($ctrl.message="Your passwords did not match.",$ctrl.allowSubmit=!1)):($ctrl.message="Your password must be at 8 or more characters and contain at least one lower and uppercase letter and one number.",$ctrl.allowSubmit=!1)}}),$scope.requireEmail=function(socialName,data){onTabSelected($ctrl.signUpIndex),$ctrl.socialMode=!0,$ctrl.isRequestSucces=!1,setTimeout(function(){$ctrl.message=data.message,$scope.$apply()},100)}},templateUrl:Stratus.BaseUrl+Stratus.BundlePath+"components/userAuthentication"+(Stratus.Environment.get("production")?".min":"")+".html"}});