!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","angular-file-upload","stratus.components.search","stratus.components.pagination","stratus.components.mediaDetails","stratus.components.mediaUploader","stratus.directives.singleClick","stratus.directives.src","stratus.services.registry","stratus.services.utility","stratus.services.media"],factory):factory(root.Stratus,root._,root.angular)}(this,function(Stratus,_,angular){Stratus.Modules.ngFileUpload=!0,Stratus.Components.MediaLibrary={bindings:{ngModel:"=",isSelector:"<"},controller:function($scope,$attrs,Registry,$mdDialog,utility,media){utility.componentInitializer(this,$scope,$attrs,"media_library",!0);var $ctrl=this;function toggleLibrary(){$ctrl.showLibrary?$ctrl.showLibrary=!1:$ctrl.showLibrary=!0}function getThumbnailImgOfVideo(fileData){return"youtube"===fileData.service?"https://img.youtube.com/vi/"+function(url){var ID="";ID=void 0!==(url=url.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/))[2]?(ID=url[2].split(/[^0-9a-z_]/i))[0]:url;return ID}(fileData.file)+"/0.jpg":"vimeo"===fileData.service?"https://i.vimeocdn.com/video/"+function(url){var ID="";void 0!==(url=url.split("https://vimeo.com/"))[1]&&(ID=url[1]);return ID}(fileData.file)+"_150x150.jpg":"https://img.youtube.com/vi/default.jpg"}function openUploader(ngfMultiple,files,invalidFiles){$mdDialog.show({attachTo:angular.element(document.querySelector("#listContainer")),controller:function(scope,collection,ngfMultiple,draggedFiles,invalidFiles){scope.collection=collection,scope.ngfMultiple=ngfMultiple,scope.draggedFiles=draggedFiles,scope.invalidFiles=invalidFiles},template:'<stratus-media-uploader collection="collection" ngf-multiple="ngfMultiple" file-id="fileId" dragged-files="draggedFiles" invalid-files="invalidFiles"></stratus-media-uploader>',clickOutsideToClose:!1,focusOnOpen:!0,autoWrap:!0,multiple:!0,locals:{collection:$scope.collection,ngfMultiple:ngfMultiple,draggedFiles:files,invalidFiles:invalidFiles}})}function showDetails(media){$mdDialog.show({attachTo:angular.element(document.querySelector("#listContainer")),controller:function($scope,media,collection){$scope.media=media,$scope.collection=collection},template:'<stratus-media-details media="media" collection="collection"></stratus-media-details>',clickOutsideToClose:!1,focusOnOpen:!0,autoWrap:!0,locals:{media:media,collection:$scope.collection}})}function deleteMedia(fileId){Stratus.Environment.get("production")||console.log(fileId),$mdDialog.show($mdDialog.confirm().title("DELETE MEDIA").textContent("Are you sure you want to permanently delete this from your library? You may get broken images if any content still uses this image.").multiple(!0).ok("Yes").cancel("No")).then(function(){media.deleteMedia(fileId).then(function(response){utility.getStatus(response).code===utility.RESPONSE_CODE.success?media.getMedia($scope):$mdDialog.show($mdDialog.alert().parent(angular.element(document.querySelector("#popupContainer"))).clickOutsideToClose(!1).title("Error").multiple(!0).textContent(utility.getStatus(response).message).ok("Ok"))},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})})}function addOrRemoveFile(selectedStatus,fileId){var i,j;if($ctrl.showPlusIcon=!$ctrl.showPlusIcon,!0===selectedStatus){for(i=0;i<$ctrl.draggedFiles.length;i++)if($ctrl.draggedFiles[i].id===fileId)for($ctrl.draggedFiles.splice(i,1),j=0;j<$scope.collection.models.length;j++)$scope.collection.models[j].data.id===fileId&&($scope.collection.models[j].data.selectedClass=!1)}else!1!==selectedStatus&&void 0!==selectedStatus||media.fetchOneMedia(fileId).then(function(response){var i;for($ctrl.draggedFiles.push(response.data.payload),i=0;i<$scope.collection.models.length;i++)$scope.collection.models[i].data.id===fileId&&($scope.collection.models[i].data.selectedClass=!0)})}function removeFromSelected(fileId){var i;for($ctrl.showPlusIcon=!$ctrl.showPlusIcon,i=0;i<$ctrl.draggedFiles.length;i++)$ctrl.draggedFiles[i].id===fileId&&$ctrl.draggedFiles.splice(i,1);for(i=0;i<$scope.collection.models.length;i++)$scope.collection.models[i].data.id===fileId&&($scope.collection.models[i].data.selectedClass=!1)}$ctrl.$onInit=function(){$ctrl.showLibrary=!$ctrl.isSelector,$ctrl.showPlusIcon=!0,$ctrl.draggedFiles=[],$ctrl.showDetails=showDetails,$ctrl.deleteMedia=deleteMedia,$ctrl.openUploader=openUploader,$ctrl.toggleLibrary=toggleLibrary,$ctrl.addOrRemoveFile=addOrRemoveFile,$ctrl.removeFromSelected=removeFromSelected,$ctrl.getThumbnailImgOfVideo=getThumbnailImgOfVideo,$ctrl.registry=new Registry,$ctrl.registry.fetch({target:$attrs.target||"Media",id:null,manifest:!1,decouple:!0,api:{limit:_.isJSON($attrs.limit)?JSON.parse($attrs.limit):30}},$scope)},$scope.$watch("$ctrl.ngModel",function(data){console.log(data),_.isUndefined(data)||_.isEqual($scope.draggedFiles,data)||($ctrl.draggedFiles=data||[])}),$scope.$watch("collection.models",function(data){if(!_.isUndefined(data)&&$ctrl.draggedFiles.length>0)for(var i=0;i<$ctrl.draggedFiles.length;i++)for(var addedFile=$ctrl.draggedFiles[i],j=0;j<$scope.collection.models.length;j++){var media=$scope.collection.models[j];addedFile.id===media.data.id&&(media.data.selectedClass=!0)}})},templateUrl:Stratus.BaseUrl+Stratus.BundlePath+"components/mediaLibrary"+(Stratus.Environment.get("production")?".min":"")+".html"}});