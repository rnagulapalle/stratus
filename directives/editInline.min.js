!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","jquery","angular","stratus.services.model"],factory):factory(root.Stratus,root._,root.jQuery,root.angular)}(this,function(Stratus,_,jQuery,angular){Stratus.Directives.EditInline=function($parse,$log,Model){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",emptyValue:"@",prefix:"@",suffix:"@",stratusEdit:"=",alwaysEdit:"@",autoSave:"@"},link:function($scope,$element,$attrs,ngModel){if($scope.uid=this.uid=_.uniqueId("edit_"),Stratus.Instances[this.uid]=$scope,$scope.value=$scope.originalValue=$element.html(),$scope.$value=jQuery(document.createElement("span")),$scope.$value.html($scope.value||$scope.emptyValue||""),$scope.model=null,ngModel&&$scope.property){var ctrl={initialized:!1,rendered:!1};ngModel.$render=function(){!1===ctrl.rendered?(ctrl.rendered=!0,$scope.findAffix(),$element.empty(),$scope.prefix&&($scope.$prefix=jQuery(document.createElement("span")),$scope.$prefix.html($scope.prefix),$scope.$prefix.attr("prefix",""),$element.append($scope.$prefix)),$element.append($scope.$value),$scope.suffix&&($scope.$suffix=jQuery(document.createElement("span")),$scope.$suffix.html($scope.suffix),$scope.$suffix.attr("suffix",""),$element.append($scope.$suffix))):$scope.$value.html($scope.value||$scope.emptyValue||"")},$scope.findAffix=function(){_.some($element.find("[prefix]"),function(el){return $scope.prefix=jQuery(el).html(),!0}),_.some($element.find("[suffix]"),function(el){return $scope.suffix=jQuery(el).html(),!0})},$scope.liveEditStatus=function(){if(ctrl.initialized){if(void 0!==$scope.stratusEdit)return $scope.stratusEdit;if(void 0!==Stratus.Environment.data.liveEdit)return Stratus.Environment.data.liveEdit;console.warn($scope.uid+" has no variable to track edit toggle! ($scope.stratusEdit)")}return!1},$scope.read=function(){ctrl.initialized&&($scope.value=$scope.$value.html())},$scope.moveCaret=function(moveAmount,win){var sel,range;if(void 0===win&&(win=window),win.getSelection&&(sel=win.getSelection()).rangeCount>0){var textNode=sel.focusNode;if(void 0===textNode.length&&textNode.childNodes[0]&&(textNode=textNode.childNodes[0]),void 0===textNode.length)return console.warn("stratus-edit-inline could not grab selection"),!1;var newOffset=sel.focusOffset+moveAmount;(range=document.createRange()).setStart(textNode,Math.min((textNode.length||0)+moveAmount,newOffset)),range.setStart(textNode,moveAmount),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range)}},$scope.accept=function(){ctrl.initialized&&$scope.model instanceof Model&&$scope.property&&$scope.model.get($scope.property)!==$scope.value&&($scope.model.set($scope.property,$scope.value),$scope.model.throttleSave())},$scope.cancel=function(){ctrl.initialized&&$scope.model instanceof Model&&$scope.property&&($scope.value=$scope.model.get($scope.property))},$scope.$watch("ngModel",function(data){if(data instanceof Model&&!_.isEqual(data,$scope.model)&&($scope.model=data,!0!==ctrl.initialized))var unwatch=$scope.$watch("model.data",function(dataCheck){void 0!==dataCheck&&(unwatch(),ctrl.init())})}),ctrl.init=function(){ctrl.initialized||(ctrl.initialized=!0,$scope.$watch("model.data."+$scope.property,function(data){$scope.value=data,ngModel.$render()}),!0!==$scope.alwaysEdit&&"true"!==$scope.alwaysEdit?$scope.$watch($scope.liveEditStatus,function(liveEdit){$scope.$value.attr("contenteditable",liveEdit),liveEdit?$element.addClass("liveEdit"):$element.removeClass("liveEdit")}):$scope.$value.attr("contenteditable",!0),$scope.$value.on("focus",function(){$element.addClass("focus")}),$scope.$value.on("focusout",function(){$element.removeClass("focus")}),$scope.$value.on("focusout keyup change",function(event){if(ctrl.initialized&&($scope.$apply($scope.read),!1!==$scope.autoSave&&"false"!==$scope.autoSave))switch(event.type){case"focusout":case"blur":$scope.$apply($scope.accept)}}),$scope.$value.on("keydown keypress",function(event){if(ctrl.initialized)switch(event.which){case Stratus.Key.Enter:event.preventDefault(),!1!==$scope.autoSave&&"false"!==$scope.autoSave&&$scope.$apply($scope.accept),$scope.$value.blur();break;case Stratus.Key.Escape:$scope.$apply($scope.cancel),$scope.$value.blur()}}))}}else console.warn($scope.uid+" has no model or property!")}}}});