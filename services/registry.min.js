!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,a){t.Services.Registry=["$provide",function(r){r.factory("Registry",["Collection","Model","$interpolate","$q",function(r,i,n,o){return function(){this.fetch=function(t,r){var i=this;return new o(function(o,u){a.isString(t)&&(t={target:t});var f={target:t.attr?t.attr("data-target"):t.target,targetSuffix:t.attr?t.attr("data-target-suffix"):t.targetSuffix,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,direct:t.attr?t.attr("data-direct"):t.direct,api:t.attr?t.attr("data-api"):t.api,urlRoot:t.attr?t.attr("data-url-root"):t.urlRoot},c=0;r.$watch(function(){return c},function(t){e.isNumber(t)&&parseInt(t)===e.size(f)&&o(i.build(f,r))}),e.each(f,function(t,e){if(t&&a.isString(t)){var i=n(t,!1,null,!0),o=i(r.$parent);a.isDefined(o)?(f[e]=o,c++):r.$watch(function(){return i(r.$parent)},function(t){t&&(f[e]=t,c++)})}else c++})})},this.build=function(n,o){var u;if(n.target){if(n.target=e.ucfirst(n.target),n.manifest||n.id){t.Catalog[n.target]||(t.Catalog[n.target]={});var f=n.id||"manifest";if(n.decouple||!t.Catalog[n.target][f]){var c={target:n.target,manifest:n.manifest,stagger:!0};n.urlRoot&&(c.urlRoot=n.urlRoot),n.targetSuffix&&(c.targetSuffix=n.targetSuffix),u=new i(c,{id:n.id}),n.decouple||(t.Catalog[n.target][f]=u)}else t.Catalog[n.target][f]&&(u=t.Catalog[n.target][f])}else{var l=n.direct?"Compendium":"Catalog";if(t[l][n.target]||(t[l][n.target]={}),n.decouple||!t[l][n.target].collection){var g={target:n.target,direct:!!n.direct};n.urlRoot&&(g.urlRoot=n.urlRoot),n.targetSuffix&&(g.targetSuffix=n.targetSuffix),u=new r(g),n.decouple||(t[l][n.target].collection=u)}else t[l][n.target].collection&&(u=t[l][n.target].collection)}n.api&&u.meta.set("api",e.isJSON(n.api)?JSON.parse(n.api):n.api),u.stagger&&"function"==typeof u.initialize&&u.initialize()}return a.isObject(u)&&(void 0!==o&&(o.data=u,u instanceof i?o.model=u:u instanceof r&&(o.collection=u)),u.pending||u.completed||u.fetch()),u}}}])}]});